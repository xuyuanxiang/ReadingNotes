#第四章 内存管理

## 4.1 程序的内存使用情况
> Objective-C可执行程序是由**（可执行）代码**、**初始化和未初始化的`程序数据`**、**链接信息**、**重定位信息**、**局部数据**和**动态数据**构成。

`程序数据`包括以静态方式声明的变量和程序常量（即在程序编译时在代码中设置的常数）。

可执行代码、程序数据以及链接与重定位信息会以静态方式被分配内存，并在程序的生命周期中一直存在。

局部（自动）数据在语句块中声明并且仅在该语句块中有效，当该语句块执行后局部数据不会继续存在。

自动数据被存储在程序栈中，程序栈通常是在执行程序/线程前就被设定尺寸的内存段。栈用于存储局部变量和调用方法/函数的上下文数据。这些上下文数据包括方法的输入参数、返回值，以及调用完方法后继续执行程序的代码地址。操作系统会自动管理这些内存；这些数据会获得栈中的内存，而分配给这些数据的内存会在它们失效后被释放。

在运行时，Objective-C会将创建的对象存储在动态分配的内存即堆内存中。 以动态方式创建对象就意味着需要进行内存管理，因为在堆内存中创建的对象永远不会超出其作用范围。

### 内存泄露
如果程序没有释放不再使用的对象，就会导致出现该问题。
如果程序没有使用为其分配的内存，就会浪费内存资源；
如果系统继续为程序分配内存并且没有释放这些内存，程序最终会耗尽系统内存。

### 悬挂指针
如果程序释放了仍在使用的对象，就会导致该问题。
如果将来程序尝试访问这些对象，就会出现程序错误。

## 4.2 Objective-C的内存模型
> Objective-C的内存管理是通过引用计数实现的，引用计数是一种通过对象的唯一引用，确定对象是否正在被使用的技术。如果对象的引用计数降到了0，对象就会被视为不再有用，而且运行时系统也会释放它的内存。

## 4.3 手动管理(MRR)
> `手动管理`是一种建立在对象所有权概念上的内存管理机制，只要对象的所有者还存在，对象就不会被Objective-C运行时环境释放。

+ 可以通过编写代码精确地管理对象的回收利用，为你创建/需要使用的对象获取所有权，放弃不再需要的对象的所有权。
+ 要研究这种管理方式，必须先理解访问和使用对象的方式以及访问对象与对象所有权之间的差别。

### 4.3.1 对象引用和对象所有权

### 4.3.2 内存管理基本原则
+ `为创建的所有对象设置所有权`。应使用名称以**alloc**、**new**、**copy**或**mutableCopy**开头的方法创建Objective-C对象。还应该通过向块发送copy消息，以动态方式创建Objective-C块对象。
+ `应该使用retain方法获取对象（你尚未拥有）的所有权`。使用NSObject类的**retain**方法可以获取对象的所有权。通常，作为方法的参数和返回值，对象可以确保其合法性。使用retain可以获取你想要长时间使用的对象的所有权，这样做通常可以将其存储为属性值，并防止其他操作无意中释放该对象。
+ `当不再使用某个对象时，必须放弃其所有权`。 使用NSObject类的**release**和**autorelease**方法可以放弃对象的所有权。使用**autorelease**方法可以在当前自动释放代码块的末尾，放弃对象的所有权。使用**release**方法可以立刻释放对象所有权。如果对象的引用计数为0，这两种方法都会对对象执行dealloc方法。
+ `不能放弃不归你所有的对象的所有权`。这样做会导致过早地释放这些对象。如果程序尝试访问已经被释放的对象，就会出现错误。

## 4.4 使用自动引用计数（ARC）

### 4.4.2 ARC的生命周期限定符

	__strong
表明任何使用alloc/init消息创建的对象都会在其作用范围内被保留。这是常规变量的**默认设置**。`作用范围`通常是指变量声明所在花括号对的内部（如方法、循环、条件语句块等）。

	 __weak
表明对象随时可以被释放。只有当对象拥有其他强引用时，该标记才会有用处。对象被释放后，带__weak限定符的变量会被设置为nil。

	__unsafe_unretained
与__weak限定符类似，但是在对象被释放后，指针不会被设置为nil，而是会处于悬挂状态（不再指向合法对象）。

	__autoreleasing
这个限定符用于通过引用传递对象。

当使用ARC生命周期限定符声明Objective-C的对象变量时，可使用下面的语法：
	
	类名 *限定符 变量名;

### 4.4.4 避免循环引用
*Objective-C的引用计数模型是通过获取对象的所有权（通过retain消息），以及在不再使用对象后释放对象的所有权（通过release消息）实现的。*

父对象强引用其所有的子对象，子对象弱引用其父对象（在必要的情况下）。
 